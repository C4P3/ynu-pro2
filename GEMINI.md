# GEMINI.md

## このドキュメントの更新方法
このドキュメントはプロジェクトの現状を反映している必要があります。コードベースに大きな変更（新しい主要機能の追加、アーキテクチャの変更など）が加えられた場合は、以下のプロンプトをAIアシスタントに与えることで、このドキュメントを更新してください。

```
GEMINI.mdが古いので、現在の実装状況を反映させたい。また、更新が必要なときに自身で更新をするようなプロンプトを含めたい。さらに、TODOを含めるようにしたい
```

---

## 概要
このプロジェクトは、Unityで開発されたタイピング探索ゲームです。プレイヤーはタイピングによってキャラクターを操作し、ステージを探索します。シングルプレイモードと、PlayFabを利用したマルチプレイモードが実装されています。

## ゲームプレイ
- **タイピング**: ローマ字入力によるタイピングで、様々なアクションを行います。
- **探索**: ステージを探索し、アイテムを発見したり、ギミックを解除したりします。
- **ア��テム**: ゲームを有利に進めるための様々なアイテムが存在します。（爆弾、酸素回復、毒、ロケット、スター、雷など）

## 主な機能
- **シングルプレイ**: 一人で遊ぶモードです。
- **マルチプレイ**: PlayFabとUnity Relay (Mirror) を利用したオンラインマルチプレイに対応しており、ルーム作成や自動マッチングが可能です。
- **ランキング**: スコアなどを競うランキング機能があります。
- **チュートリアル**: ゲームの遊び方を学べるチュートリアルがあります。

## 技術スタック
- **ゲームエンジン**: Unity
- **ネットワーキング**: Mirror, Unity Relay
- **バックエンド**: PlayFab (認証, マッチメイキング, データストレージ)
- **言語**: C#

## TODO
- [ ] **リファクタリング**: `GameManager.cs` と `GameManagerMulti.cs` に重複するロジックがあるため、共通化を検討する。
- [ ] **ランキング機能の実装**: 現在はUIのみで、PlayFab Leaderboardを利用した本格的な実装が必要。
- [ ] **アイテム追加**: 新しい効果を持つアイテムを数種類追加する。
- [ ] **エラーハンドリング**: PlayFab API呼び出し部分のエラーハンドリングを強化し、ユーザーへの���ィードバックを改善する。
- [ ] **テスト**: マルチプレイ部分の結合テストを拡充する。

---

## 主要なスクリプトと連携

### マルチプレイの処理フロー
このゲームのマルチプレイは、**PlayFab (Lobby, Matchmaking)** と **Unity Relay (Mirror)** を組み合わせて実現されています。

1.  **認証 (PlayFabAuthManager)**
    *   ゲーム起動時に `PlayFabAuthManager` が `PlayFabClientAPI.LoginWithCustomID` を使用して、端末固有IDによる匿名認証を行います。

2.  **ルーム作成 (ホスト側)**
    *   プレイヤーが「ホストになる」を選択すると、`PlayFabMatchMakingManager.CreateRoom()` が呼び出されます。
    *   `MyRelayNetworkManager.StartRelayHost()` が実行され、Unity Relayサーバー上でホストを開始し、Join Codeを生成します。

3.  **ルーム参加 (クライアント側)**
    *   別のプレイヤーがJoin Codeを入力して「参加する」を選択すると、`PlayFabMatchMakingManager.JoinRoom()` が呼び出されます。
    *   入力されたJoin Codeを使い、リレーサーバーにクライアントとして接続します。

4.  **プレイヤーオブジェクトの生成と同期**
    *   クライアントがサーバーに接続すると、`MyRelayNetworkManager.OnServerAddPlayer()` がトリガーされ、プレイヤーオブジェクトが生成されます。
    *   `NetworkPlayerInput` コンポーネントに `playerIndex` (1 or 2) が設定され、各クライアントは自身の役割を認識します。

5.  **ゲーム開始同期**
    *   接続プレイヤー数が2人になると、サーバーは `GameDataSync.Instance.StartGameSequence()` を呼び出します。
    *   `GameDataSync` の `[SyncVar]` 変数 `GameState` が `Countdown` になると、全クライアントが同期されたシード値でマップ生成を開始します。

6.  **ゲーム中の入力とアクションの同期**
    *   ローカルプレイヤーの入力は `NetworkPlayerInput` で検知され、`[Command]` を通じてサーバーに送信されます。
    *   サーバーは処理結果を `[ClientRpc]` で全クライアントにブロードキャストし、ゲーム状態を同期させます。

### 主要スクリプト

- **`GameManager.cs`**:
    - **シングルプレイ**のゲーム全体の進行管理（酸素、生存時間、スコア、ゲームオーバー処理）を行うシングルトン。

- **`GameManagerMulti.cs`**:
    - **マルチプレイ**のゲーム全体の進行管理を行う。`GameDataSync` と連携し、両プレイヤーの状態を同期す��。

- **`PlayerController.cs`**:
    - プレイヤーの移動、状態（通常、移動中、タイピング中）を管理する。`TypingManager` のイベントに応じてアクションを実行する。

- **`TypingManager.cs`**:
    - タイピングのロジック（入力判定、UI表示）を管理する。タイピング完了時にイベントを発行し `PlayerController` に通知する。

- **`ItemManager.cs`**:
    - アイテムのデータベースと効果の発動を管理するシングルトン。

- **`LevelManager.cs`**:
    - ステージ（タイルマップ）の生成と管理を行う。

- **`PlayFabAuthManager.cs`**:
    - PlayFabへの匿名認証を管理するシングルトン。

- **`PlayFabMatchMakingManager.cs`**:
    - PlayFabを利用したマッチメイキング（ルーム作成、参加）を管理するシングルトン。`MyRelayNetworkManager` と連携する。

- **`MyRelayNetworkManager.cs`**:
    - Mirrorの`NetworkManager`を継承し、Unity Relayサービスとの連携を担う。

- **`UIController.cs`**:
    - ゲーム全体のUI（CanvasGroup）の表示/非表示を管理し、画面遷移を実現する。
